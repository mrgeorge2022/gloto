<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gloto | Plaza Digital</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { glotoNeon: '#CCFF00', glotoSpace: '#050505', glotoDark: '#121212' },
                    borderRadius: { '4xl': '2rem', '5xl': '3rem' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body, html { height: 100%; margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background-color: #050505; color: white; overflow: hidden; }
        .font-logo { font-family: 'Unbounded', sans-serif; }
        
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; opacity: 0; transition: opacity 1s ease; }
        #map.loaded { opacity: 1; }
        .leaflet-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        
        #loader-gloto {
            position: fixed; inset: 0; background: #050505; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease;
        }

        #results-panel, #quick-view {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(5, 5, 5, 0.98); backdrop-blur: 20px;
            border-top: 2px solid rgba(204, 255, 0, 0.3);
            transform: translateY(110%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 600px; margin: 0 auto;
        }

        #results-panel { height: 38vh; z-index: 500; border-radius: 3rem 3rem 0 0; padding: 1.5rem; }
        #quick-view { z-index: 1000; border-radius: 3rem 3rem 0 0; padding: 2rem; }

        .open { transform: translateY(0) !important; }

        .custom-marker { width: 18px; height: 18px; background: #CCFF00; border: 3px solid #050505; border-radius: 50%; box-shadow: 0 0 15px #CCFF00; cursor: pointer; }
        .user-marker { width: 22px; height: 22px; background: #00F0FF; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 20px #00F0FF; }
        input[type=range] { accent-color: #CCFF00; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .cat-active { background-color: #CCFF00 !important; color: #050505 !important; border-color: #CCFF00 !important; font-weight: 900 !important; }
    </style>
</head>
<body>

    <div id="loader-gloto">
        <div class="text-center p-8 max-w-xs">
            <h1 class="font-logo text-glotoNeon italic text-4xl mb-6 tracking-tighter">GLOTO</h1>
            <p class="text-[10px] uppercase tracking-[0.2em] text-white/40 mb-10 leading-relaxed">Bienvenido a la Plaza Digital.</p>
            <button onclick="requestLocationAndStart()" id="btn-start" class="w-full bg-glotoNeon text-black py-5 rounded-2xl font-black uppercase text-xs tracking-widest active:scale-95 transition-all">
                Entrar a la Plaza
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div class="relative z-10 pointer-events-none h-full flex flex-col p-4 md:p-8">
        <header class="pointer-events-auto w-full max-w-2xl mx-auto space-y-4">
            <div class="flex items-center bg-glotoDark/90 backdrop-blur-xl p-4 rounded-3xl border border-white/10 shadow-2xl">
                <h1 class="font-logo text-2xl text-glotoNeon italic mr-4 leading-none">G</h1>
                <input type="text" id="search-input" onkeyup="searchBiz()" placeholder="¬øQu√© buscas?" class="bg-transparent flex-1 outline-none text-sm font-bold text-white placeholder-white/20">
                <button onclick="toggleFiltersModal()" class="ml-2 bg-glotoNeon text-black p-3 rounded-2xl active:scale-90 transition-all">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar" id="filters-container"></div>
        </header>

        <div class="mt-auto flex justify-between items-end pointer-events-auto pb-10">
            <a href="unirse.html" class="bg-glotoDark border border-glotoNeon/30 text-white px-5 py-4 rounded-2xl shadow-2xl flex items-center gap-3 active:scale-95 transition-all group">
                <div class="w-8 h-8 bg-glotoNeon rounded-lg flex items-center justify-center text-black">
                    <i class="fas fa-store text-sm"></i>
                </div>
                <div class="text-left">
                    <p class="text-[8px] text-white/40 uppercase font-black leading-none">Socio Gloto</p>
                    <p class="text-[10px] font-bold uppercase tracking-tighter">Unir mi Negocio</p>
                </div>
            </a>

            <button onclick="locateUser()" class="w-14 h-14 bg-glotoDark border border-glotoNeon/50 text-glotoNeon rounded-2xl shadow-2xl flex items-center justify-center active:scale-90 transition-all">
                <i class="fas fa-location-arrow text-xl"></i>
            </button>
        </div>
    </div>

    <div id="advanced-filters-modal" class="fixed inset-0 bg-glotoSpace/95 backdrop-blur-2xl z-[2000] hidden flex items-center justify-center p-6">
        <div class="bg-glotoDark border border-white/10 w-full max-w-md rounded-[3rem] p-8">
            <div class="flex justify-between items-center mb-10">
                <h2 class="font-logo text-glotoNeon italic text-xl uppercase">Filtros</h2>
                <button onclick="closeAllPanels()" class="text-white/40 text-3xl">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <div class="flex justify-between mb-4">
                        <p class="text-[10px] text-white/40 uppercase font-black">Radar de Distancia</p>
                        <span id="dist-val" class="text-glotoNeon font-bold">Sin l√≠mite</span>
                    </div>
                    <input type="range" id="range-distance" min="0" max="15000" step="500" value="0" class="w-full cursor-pointer">
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="applySort('new')" class="bg-white/5 p-5 rounded-2xl text-[10px] font-black uppercase text-left flex justify-between items-center border border-white/5 hover:border-glotoNeon">‚ú® Nuevos <span>Menos de 30 d√≠as</span></button>
                    <button onclick="applySort('top')" class="bg-white/5 p-5 rounded-2xl text-[10px] font-black uppercase text-left flex justify-between items-center border border-white/5 hover:border-glotoNeon">üèÜ Mejor Valorados <span>Rating</span></button>
                    <button onclick="applySort('fast')" class="bg-white/5 p-5 rounded-2xl text-[10px] font-black uppercase text-left flex justify-between items-center border border-white/5 hover:border-glotoNeon">‚ö° M√°s R√°pido <span>Tiempo</span></button>
                </div>
            </div>
        </div>
    </div>

    <div id="results-panel">
        <div class="flex justify-between items-center mb-6 px-2">
            <div>
                <h3 id="panel-title" class="font-logo text-glotoNeon italic text-xs uppercase tracking-widest">Resultados</h3>
            </div>
            <button onclick="closeResults()" class="w-10 h-10 bg-white/5 rounded-full flex items-center justify-center text-white/40"><i class="fas fa-chevron-down"></i></button>
        </div>
        <div id="results-list" class="flex gap-4 overflow-x-auto no-scrollbar pb-6 px-2"></div>
    </div>

    <div id="quick-view">
        <div id="qv-content"></div>
        <div class="flex gap-4 mt-8">
            <button onclick="closeQuickView()" class="flex-1 bg-white/5 py-5 rounded-2xl font-black uppercase text-[10px]">Cerrar</button>
            <a id="qv-link" href="#" target="_blank" class="flex-[2] bg-glotoNeon text-black py-5 rounded-2xl font-black uppercase text-[10px] text-center font-bold">VER TIENDA</a>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyYfkQp0sa1h3zLepqP9zBXt7Rf4r-NqY_euO5g3s2R1tYsybozoRFFNPNIIHnDdxGp/exec'; 
        let map, userMarker, proximityCircle, userCoords = null;
        let businessData = [];
        let activeMarkers = [];

        function closeAllPanels() {
            document.getElementById('results-panel').classList.remove('open');
            document.getElementById('quick-view').classList.remove('open');
            document.getElementById('advanced-filters-modal').classList.add('hidden');
        }

        async function requestLocationAndStart() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    initMap();
                    await cargarNegocios();
                    document.getElementById('loader-gloto').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader-gloto').style.display = 'none', 600);
                });
            }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([userCoords.lat, userCoords.lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            userMarker = L.marker([userCoords.lat, userCoords.lng], { icon: L.divIcon({ className: 'user-marker' }) }).addTo(map);
            proximityCircle = L.circle([userCoords.lat, userCoords.lng], {
                radius: 0, color: '#CCFF00', fillColor: '#CCFF00', fillOpacity: 0.1, weight: 1, dashArray: '5, 10'
            }).addTo(map);
            document.getElementById('map').classList.add('loaded');
        }

        async function cargarNegocios() {
            const res = await fetch(API_URL);
            businessData = await res.json();
            renderMarkers(businessData);
            renderQuickFilters();
        }

        function renderQuickFilters() {
            const container = document.getElementById('filters-container');
            const cats = [...new Set(businessData.map(b => b.type))].filter(t => t);
            container.innerHTML = `<button id="cat-all" onclick="selectCategory('all')" class="bg-glotoDark border border-white/10 text-white/50 px-6 py-2 rounded-full text-[10px] font-black uppercase whitespace-nowrap pointer-events-auto cat-btn cat-active">Todos</button>`;
            cats.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "bg-glotoDark border border-white/10 text-white/50 px-6 py-2 rounded-full text-[10px] font-black uppercase whitespace-nowrap pointer-events-auto cat-btn";
                btn.innerText = c;
                btn.onclick = () => selectCategory(c, btn);
                container.appendChild(btn);
            });
        }

        function selectCategory(cat, btnElement) {
            closeAllPanels();
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('cat-active'));
            if(cat === 'all') document.getElementById('cat-all').classList.add('cat-active');
            else btnElement.classList.add('cat-active');

            const filtered = cat === 'all' ? businessData : businessData.filter(b => b.type === cat);
            renderMarkers(filtered);
            if(cat !== 'all') showInPanel(filtered, cat);
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function isNew(dateStr) {
            if(!dateStr) return false;
            const businessDate = new Date(dateStr);
            const today = new Date();
            const diffInDays = Math.floor((today - businessDate) / (1000 * 60 * 60 * 24));
            return diffInDays >= 0 && diffInDays <= 30;
        }

        function applySort(mode) {
            closeAllPanels();
            let filtered = [...businessData];
            const maxDist = parseInt(document.getElementById('range-distance').value);
            
            if(maxDist > 0) {
                filtered = filtered.filter(b => getDistance(userCoords.lat, userCoords.lng, b.lat, b.lng) <= maxDist);
                map.setView([userCoords.lat, userCoords.lng], 14);
            }

            if (mode === 'new') {
                filtered = filtered.filter(b => isNew(b.fecha_creacion));
                showInPanel(filtered, "Nuevos (√öltimos 30 d√≠as)");
            } else if (mode === 'top') {
                filtered.sort((a, b) => b.rating - a.rating);
                showInPanel(filtered, "Mejor Valorados");
            } else if (mode === 'fast') {
                filtered.sort((a, b) => parseInt(a.time) - parseInt(b.time));
                showInPanel(filtered, "M√°s R√°pidos");
            }
            renderMarkers(filtered);
        }

        function showInPanel(data, title) {
            document.getElementById('panel-title').innerText = title.toUpperCase();
            const list = document.getElementById('results-list');
            list.innerHTML = '';
            
            if(data.length === 0) {
                list.innerHTML = `<p class="text-[10px] text-white/20 uppercase font-black p-4">No se encontraron resultados</p>`;
            }

            data.forEach(biz => {
                const km = (getDistance(userCoords.lat, userCoords.lng, biz.lat, biz.lng) / 1000).toFixed(1);
                const isBizNew = isNew(biz.fecha_creacion);
                
                const card = document.createElement('div');
                card.className = "min-w-[180px] bg-glotoDark border border-white/5 p-4 rounded-[2.5rem] cursor-pointer relative";
                card.innerHTML = `
                    <div class="relative mb-3">
                        <img src="${biz.img}" class="w-full h-24 object-cover rounded-2xl">
                        ${isBizNew ? '<span class="absolute top-2 left-2 bg-glotoNeon text-black text-[7px] font-black px-2 py-1 rounded-full shadow-lg border border-black/10">NUEVO</span>' : ''}
                        <span class="absolute bottom-2 right-2 bg-black/80 text-glotoNeon text-[7px] font-black px-2 py-1 rounded-full border border-white/10">${km} KM</span>
                    </div>
                    <p class="text-[10px] font-black uppercase text-white truncate">${biz.name}</p>
                    <p class="text-[8px] text-white/30 font-bold uppercase mt-1">${biz.rating} ‚òÖ ‚Ä¢ ${biz.time}</p>`;
                card.onclick = () => openQuickView(biz);
                list.appendChild(card);
            });
            document.getElementById('results-panel').classList.add('open');
        }

        function renderMarkers(data) {
            activeMarkers.forEach(m => map.removeLayer(m));
            activeMarkers = [];
            data.forEach(b => {
                const m = L.marker([b.lat, b.lng], { icon: L.divIcon({ className: 'custom-marker' }) }).addTo(map).on('click', () => openQuickView(b));
                activeMarkers.push(m);
            });
            if(data.length > 0) map.fitBounds(new L.featureGroup(activeMarkers).getBounds().pad(0.3));
        }

        function openQuickView(biz) {
            closeAllPanels();
            const content = document.getElementById('qv-content');
            content.innerHTML = `
                <div class="flex gap-6 items-center mb-6">
                    <div class="relative">
                        <img src="${biz.img}" class="w-24 h-24 object-cover rounded-[2rem] border-2 border-glotoNeon/20">
                        ${isNew(biz.fecha_creacion) ? '<span class="absolute -top-2 -right-2 bg-glotoNeon text-black text-[8px] font-black px-3 py-1 rounded-full">NUEVO</span>' : ''}
                    </div>
                    <div>
                        <h3 class="font-logo text-glotoNeon italic text-2xl leading-none mb-1">${biz.name}</h3>
                        <p class="text-[9px] text-white/40 uppercase font-black">${biz.cat}</p>
                        <p class="text-xs font-bold mt-2 text-white">${biz.rating} ‚òÖ ‚Ä¢ ${biz.time}</p>
                    </div>
                </div>
                <div class="bg-white/5 p-6 rounded-3xl border border-white/5">
                    <p class="text-white/70 text-sm italic leading-relaxed">${biz.products}</p>
                </div>`;
            document.getElementById('qv-link').href = `https://google.com/search?q=${encodeURIComponent(biz.name)}`;
            document.getElementById('quick-view').classList.add('open');
            map.panTo([biz.lat, biz.lng]);
        }

        document.getElementById('range-distance').oninput = (e) => {
            const v = e.target.value;
            const label = document.getElementById('dist-val');
            if(v == 0) {
                label.innerText = "Sin l√≠mite";
                proximityCircle.setRadius(0);
            } else {
                label.innerText = v >= 1000 ? (v/1000).toFixed(1) + 'km' : v + 'm';
                proximityCircle.setRadius(v);
                map.setView([userCoords.lat, userCoords.lng], map.getZoom());
            }
        };

        function searchBiz() {
            const q = document.getElementById('search-input').value.toLowerCase();
            if(q.length > 2) {
                closeAllPanels();
                const filtered = businessData.filter(b => b.name.toLowerCase().includes(q) || b.products.toLowerCase().includes(q));
                renderMarkers(filtered);
                showInPanel(filtered, "Resultados");
            }
        }

        function locateUser() { closeAllPanels(); map.setView([userCoords.lat, userCoords.lng], 16); }
        function toggleFiltersModal() { 
            const modal = document.getElementById('advanced-filters-modal');
            if(modal.classList.contains('hidden')) { closeAllPanels(); modal.classList.remove('hidden'); }
            else modal.classList.add('hidden');
        }
        function closeResults() { document.getElementById('results-panel').classList.remove('open'); }
        function closeQuickView() { document.getElementById('quick-view').classList.remove('open'); }
    </script>
</body>
</html>